
{% extends 'qpanalyze/base.html' %}

{% block mymessage %}
{% load static %}


<div class="pagetitle">
    <h1>Analyze By PDF</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item">Analyze</li>
        <li class="breadcrumb-item active">Analyze By PDF</li>
      </ol>
    </nav>
</div><!-- End Page Title -->

<section class="section">
    <div class="row">
      <div class="col-lg-9">
        <form method="POST" action="{% url 'questions' %}" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Question Paper Information</h5>

              <!-- General Form Elements -->
              
                <div class="row mb-3">
                  <label for="inputText" class="col-sm-2 col-form-label">Department</label>
                  <div class="col-sm-10">
                    <!-- <input type="text" class="form-control"> -->
                    <select class="form-select" aria-label="Departments" id="department" name="department" required>
                      <option selected>-- Select Department -- </option>
                      {% for department in departments %}
                        <option value="{{department.department_code}}">{{department}}</option>
                      {% endfor%}
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="inputText" class="col-sm-2 col-form-label">Semester</label>
                  <div class="col-sm-10">
                    <select class="form-select" aria-label="sem" id="semester" name="semester" required>
                      <option selected>-- Select Semester -- </option>
                      {% for value, label in semesters %}
                      <option value="{{value}}">{{label}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <label class="col-sm-2 col-form-label">Exam Type</label>
                  <div class="col-sm-10">
                    <select class="form-select" aria-label="Exam Type" id="exam_type" name="exam_type" required>
                      <option selected>-- Select Exam Type --</option>
                      {% for value, label in exam_type %}
                      <option value="{{value}}">{{label}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="inputNumber" class="col-sm-2 col-form-label">Number of papers</label>
                  <div class="col-sm-10">
                    <input type="number" class="form-control" id="subject_count" name="subject_count" value=0 readonly>
                  </div>
                </div>
                <div class="card">
                   <div class="card-body" id="subject_container">
                    <h6 class="card-title">Details of each question paper</h6>
                   </div>
                </div>

                <div class="row mb-3">
                  <div class="col-10 text-center">
                    <button type="submit" class="btn btn-primary w-50">Submit</button>
                  </div>
                </div>

            <!-- End General Form Elements -->

            </div>
          </div>
        </form>
      </div>
    </div>
</section>

<script>
  $(document).ready(function () {
    function fetchSubjects() {
      var department_code = $('#department').val();
      var semester = $('#semester').val();
      var subject_container = $('#subject_container');

      if(department_code && semester){
        $.ajax({
          url: window.location.href,  // Call the same URL
          data: {
              'department_code': department_code,
              'semester': semester
          },
          dataType: 'json',
          success: function(data){
            $.each(data, function(index, subject) {
              console.log(subject);
              $('#subject').append('<option value="'+subject.subject_code+'">'+subject.subject_code + ' - ' + subject.subject_name +'</option>');
            });
            
            $('#subject_count').val(data.length);
            if (data.length > 0){
              $.each(data, function(index, subject) {
                var dropdown = `
                <div class='row mb-3'>
                  <div class='col-sm-1'>
                    <label for='subject_${index+1}' class='form-label'>#${index+1}</label>
                  </div>
                  <div class='col-sm-5'>
                    <select class="form-select" aria-label="Subject Code" id="subject_${index+1}" name="subject_${index+1}" required>
                      <option selected>-- Select Subject -- </option>
                      <option value="${subject.subject_code}">${subject.subject_code} - ${subject.subject_name}</option>
                    </select>
                  </div>
                  <div class="col-sm-6">
                    <input class="form-control" type="file" id="file_${index+1}" name="file_${index+1}" accept=".pdf" required>
                  </div>
                </div>`;
                subject_container.append(dropdown);
              });
            }
          },
          error: function(error){
            console.error('Ajax Error: ', status, error);
          }
        });
      }
    }

    function populate_details(subject_count){
      var subject_container = $('#subject_container');

      console.log(subject_count)
      
      if(subject_count > 0){
        for (var i = 1; i <= subjectCount; i++) {
          var dropdown = `<div class='row mb-3'>
            <div class='col-sm-1'>
              <label for='subject_${i}' class='form-label'>#${i}</label>
            </div>
            <div class='col-sm-5'>
              <select class="form-select" aria-label="Subject Code" id="subject_${i}" required>
                <option selected>-- Select Subject -- </option>
              </select>
            </div>
            <div class="col-sm-6">
              <input class="form-control" type="file" id="formFile" required>
            </div>
          </div>`;
          subject_container.append();
        }
      }
    }

    $('#department, #semester').change(function() {
      fetchSubjects(); 
    });

  });
</script>

{% endblock %} 